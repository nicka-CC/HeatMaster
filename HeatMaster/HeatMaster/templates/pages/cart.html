{% extends './layout.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/thermostats.css' %}">
{% endblock %}

{% block content %}
<div class="content">
    <div class="padding"></div>
    <div class="content_info">
        <div class="bread_crumps"><a href="{% url 'home' %}">–ì–ª–∞–≤–Ω–∞—è</a> / <div class="bread_crump">–ö–æ—Ä–∑–∏–Ω–∞</div></div>

        <div class="white-box cart-container">
            {% if cart.items.all %}
            <h2 class="cart-title">–ö–æ—Ä–∑–∏–Ω–∞</h2>
            <table class="cart-table">
                <thead>
                    <tr>
                        <th>–¢–æ–≤–∞—Ä</th>
                        <th>–¶–µ–Ω–∞</th>
                        <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                        <th>–°—É–º–º–∞</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in cart.items.all %}
                    <tr class="cart-row" data-item-id="{{ item.id }}">
                        <td class="cart-cell-product">
                            <div class="product-cell-content">
                                {% if item.thermostat.image %}
                                <img src="{{ item.thermostat.image.url }}" alt="{{ item.thermostat.name }}" class="product-image" />
                                {% endif %}
                                <a href="{% url 'thermostat_detail' item.thermostat.id %}" class="product-name">{{ item.thermostat.name }}</a>
                            </div>
                        </td>
                        <td class="cart-cell-price">
                            <span class="price-value">{{ item.thermostat.price|floatformat:2 }}</span> —Ä.
                        </td>
                        <td class="cart-cell-quantity">
                            <form class="qty-form" method="post" action="{% url 'update_cart_item' item.id %}" data-item-id="{{ item.id }}" data-price="{{ item.thermostat.price }}">
                                {% csrf_token %}
                                <div class="quantity-controls">
                                    <button type="button" class="qty-btn qty-minus" onclick="changeQuantity({{ item.id }}, -1)">‚àí</button>
                                    <input class="qty-input" type="number" name="quantity" id="qty-{{ item.id }}" min="1" value="{{ item.quantity }}" readonly />
                                    <button type="button" class="qty-btn qty-plus" onclick="changeQuantity({{ item.id }}, 1)">+</button>
                                </div>
                            </form>
                        </td>
                        <td class="cart-cell-subtotal">
                            <span class="subtotal-value" data-item-id="{{ item.id }}">{{ item.subtotal|floatformat:2 }}</span> —Ä.
                        </td>
                        <td class="cart-cell-remove">
                            <form method="post" action="{% url 'remove_cart_item' item.id %}">
                                {% csrf_token %}
                                <button class="btn-remove" type="submit" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="3" class="cart-footer-total-label">–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</td>
                        <td colspan="2" class="cart-footer-total-value">
                            <span id="cart-total">{{ cart.total_price|floatformat:2 }}</span> —Ä.
                        </td>
                    </tr>
                    <tr>
                        <td colspan="5" class="cart-footer-actions">
                            <a class="btn-checkout" href="{% url 'checkout' %}">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</a>
                        </td>
                    </tr>
                </tfoot>
            </table>
            {% else %}
            <div class="cart-empty">
                <div class="cart-empty-icon">üõí</div>
                <p>–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p>
                <a class="btn-continue-shopping" href="{% url 'thermostat_list' %}">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫–∏</a>
            </div>
            {% endif %}
        </div>
    </div>
    <div class="padding2"></div>
</div>

<script>
function changeQuantity(itemId, change) {
    const input = document.getElementById('qty-' + itemId);
    const currentQty = parseInt(input.value);
    let newQty = currentQty + change;
    
    if (newQty < 1) newQty = 1;
    
    input.value = newQty;
    updateCartItem(itemId);
}

function updateCartItem(itemId) {
    const form = document.querySelector(`.qty-form[data-item-id="${itemId}"]`);
    const price = parseFloat(form.dataset.price);
    const input = document.getElementById('qty-' + itemId);
    const quantity = parseInt(input.value);
    const subtotal = price * quantity;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É–º–º—É –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
    const subtotalElement = document.querySelector(`.subtotal-value[data-item-id="${itemId}"]`);
    if (subtotalElement) {
        subtotalElement.textContent = subtotal.toFixed(2);
    }
    
    // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â—É—é —Å—É–º–º—É
    let total = 0;
    document.querySelectorAll('.qty-form').forEach(f => {
        const itemId = f.dataset.itemId;
        const qty = parseInt(document.getElementById('qty-' + itemId).value);
        const itemPrice = parseFloat(f.dataset.price);
        total += qty * itemPrice;
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É
    const totalElement = document.getElementById('cart-total');
    if (totalElement) {
        totalElement.textContent = total.toFixed(2);
    }
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É
    form.submit();
}
</script>
{% endblock %}


